<head>
    <title>Tim Harrison</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
        integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.1.0/css/all.css">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro&display=swap" rel="stylesheet">
    <link rel='stylesheet' href='/static/styles.css' />
    <link rel='stylesheet' href='/static/mobile.css' />
</head>

<div id="header_block">
    <p class="deploy_message">This site has been generated and deployed from Github repository <a
            href="https://github.com/tjtharrison/README.md" target="_blank">tjtharrison/README.md</a></p>
    <div id="header_wrapper">


        <p><img class="me" src="/img/timh.png" /></p>

        <h2>Tim Harrison</h2>
        <h3>DevSecOps Team Lead</h3>

        <ul class="navigation">
            <li><a href="/">Home</a></li>
            <li><a href="/pages/runbooks/">Runbooks</a></li>
            <li><a href="/pages/guides">Guides</a></li>
            <li><a target="_blank"
                    href="https://www.credly.com/users/tim-harrison.41ce8b8d/badges">Credly <i
                        class="fa-solid fa-arrow-up-right-from-square"></i></a></li>
            <li><a target="_blank" href="https://github.com/tjtharrison">Github <i
                        class="fa-solid fa-arrow-up-right-from-square"></i></a></li>
            <li><a target="_blank" href="https://www.linkedin.com/in/tim-harrison-47b11159/"> LinkedIn <i
                        class="fa-solid fa-arrow-up-right-from-square"></i></a></li>
        </ul>


    </div>
</div>

<div id="body">
    </div></div><h1>Enabling Google Authenticator MFA on Ubuntu</h1>
<p>A quick guide on enabling the Google Authenticator App for SSH connections to Ubuntu 16.04 Servers.</p>
<p><em>Note: Before proceeding, ensure you have the Google Authenticator app installed on your phone:</em></p>
<p>Appstore (iPhone): https://apps.apple.com/gb/app/google-authenticator/id388497605
Play Store (Android): https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2&amp;hl=en_GB</p>
<h2>Installing and Configuring in Ubuntu:</h2>
<p>Firstly, install the package to your server:</p>
<pre class="highlight"><pre>sudo apt install -y libpam-google-authenticator</pre></pre>
<p>Now run the package to configure the MFA (Note: This should be run as the user on which you would like the MFA applied to). There will be a QR code displaying in the Terminal after running – Open up your Google Authenticator app and click “Add” to scan this barcode.</p>
<pre class="highlight"><pre>google-authenticator</pre></pre>
<p>Proceed through the settings, answering as appropriate.</p>
<p><em>Note: You should backup the ~/.google_authenticator file in your user directory as this contains the recovery keys. It is also a good idea to ensure you have console access to your server (Or a way of restoring to a previous state) in the event of any of the below going wrong!</em></p>
<p>Now run the below comamnds to update the SSH service to force MFA on login (Note: Should be run as root – sudo su included below):</p>
<pre class="highlight"><pre>sudo su
echo "auth required pam_google_authenticator.so" &gt;&gt; /etc/pam.d/sshd
sed -i 's/ChallengeResponseAuthentication no/ChallengeResponseAuthentication yes/g' /etc/ssh/sshd_config
echo "UsePAM yes" &gt;&gt; /etc/ssh/sshd_config
echo "AuthenticationMethods publickey,password publickey,keyboard-interactive" &gt;&gt; /etc/ssh/sshd_config
sed -i 's/@include common-auth/#@include common-auth/g' /etc/pam.d/sshd</pre></pre>
<h2>Restart the SSH service to apply:</h2>
<pre class="highlight"><pre>service ssh restart</pre></pre>
</div>
