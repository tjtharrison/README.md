<head>
    <title>Tim Harrison</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
        integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.1.0/css/all.css">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro&display=swap" rel="stylesheet">
    <link rel='stylesheet' href='/static/styles.css' />
</head>

<div id="header_block">
    <p class="deploy_message">This site has been deployed from Github repository <a
            href="https://github.com/tjtharrison/README.md" target="_blank">tjtharrison/README.md</a></p>
    <div id="header_wrapper">


        <p><img class="me" src="/img/timh.png" /></p>

        <h2>Tim Harrison</h2>
        <h3>Infrastructure Security Team Lead</h3>

        <ul class="navigation">
            <li><a href="/">Home</a></li>
            <li><a href="/pages/runbooks/">Runbooks</a></li>
            <li><a href="/pages/guides">Guides</a></li>
            <li><a target="_blank"
                    href="https://www.credly.com/badges/f3630def-a568-424b-a8eb-e8857e296e24/public_url">Credly <i
                        class="fa-solid fa-arrow-up-right-from-square"></i></a></li>
            <li><a target="_blank" href="https://github.com/tjtharrison">Github <i
                        class="fa-solid fa-arrow-up-right-from-square"></i></a></li>
            <li><a target="_blank" href="https://www.linkedin.com/in/tim-harrison-47b11159/"> LinkedIn <i
                        class="fa-solid fa-arrow-up-right-from-square"></i></a></li>
        </ul>


    </div>
</div>

<div id="body">
    </div></div><h1>Installing nginx ingress controller on Kubernetes</h1>
<p>Run the below to install the Nginx ingress controller on a Kubernetes Cluster:</p>
<p><code>git clone https://github.com/nginxinc/kubernetes-ingress/
cd kubernetes-ingress/deployments/helm-chart
git checkout v1.9.0</code></p>
<p><code>helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm repo update
kubectl create namespace ingress
helm install nginx ingress-nginx/ingress-nginx --set rbac.create=true -n ingress --version 3.7.1</code></p>
<p>Reference: https://docs.nginx.com/nginx-ingress-controller/installation/installation-with-helm/</p>
<h2>Failed to update lock: configmaps “ingress-controller-leader”</h2>
<p><code>Failed to update lock: configmaps "ingress-controller-leader" is forbidden: User "system:serviceaccount:ingress:nginx-ingress-nginx" cannot update resource "configmaps" in API group "" in the namespace "ingress"</code></p>
<p>If you run into the above error on the ingress deployment, this is due to the ingress user not having permissions to update the configmap for the custom deployment. This is fixed by the below steps:</p>
<p>Run the following command to get the name of your ingress controller config map:</p>
<p><code>kubectl get cm -n ingress | grep "[environment]"</code></p>
<p>(Make a note of this)</p>
<p>Now edit the role created by the helm installation:</p>
<p><code>kubectl edit role -n ingress nginx-ingress-nginx</code></p>
<p>Above the section “ingress-controller-leader-nginx”, add the following:</p>
<p><code>- apiGroups:
 - ""
 resourceNames:
  - ingress-controller-leader-[environment]
 resources:
  - configmaps
 verbs:
  - get
  - update</code></p>
<p>Restart the deployment to pick up the change and the errors should subside:</p>
<p><code>kubectl rollout restart deployment [environment]-ingress-controller -n ingress</code></p>
</div>