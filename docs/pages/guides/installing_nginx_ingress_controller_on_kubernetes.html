<head>
    <title>Tim Harrison</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
        integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.1.0/css/all.css">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro&display=swap" rel="stylesheet">
    <link rel='stylesheet' href='/static/styles.css' />
    <link rel='stylesheet' href='/static/mobile.css' />
</head>

<div id="header_block">
    <p class="deploy_message">This site has been generated and deployed from Github repository <a
            href="https://github.com/tjtharrison/README.md" target="_blank">tjtharrison/README.md</a></p>
    <div id="header_wrapper">


        <p><img class="me" src="/img/timh.png" /></p>

        <h2>Tim Harrison</h2>
        <h3>Infrastructure Team Lead</h3>

        <ul class="navigation">
            <li><a href="/">Home</a></li>
            <li><a href="/pages/runbooks/">Runbooks</a></li>
            <li><a href="/pages/guides">Guides</a></li>
            <li><a target="_blank"
                    href="https://www.credly.com/users/tim-harrison.41ce8b8d/badges">Credly <i
                        class="fa-solid fa-arrow-up-right-from-square"></i></a></li>
            <li><a target="_blank" href="https://github.com/tjtharrison">Github <i
                        class="fa-solid fa-arrow-up-right-from-square"></i></a></li>
            <li><a target="_blank" href="https://www.linkedin.com/in/tim-harrison-47b11159/"> LinkedIn <i
                        class="fa-solid fa-arrow-up-right-from-square"></i></a></li>
        </ul>


    </div>
</div>

<div id="body">
    </div></div><h1>Installing nginx ingress controller on Kubernetes</h1>
<p>Run the below to install the Nginx ingress controller on a Kubernetes Cluster:</p>
<pre class="highlight"><pre>git clone https://github.com/nginxinc/kubernetes-ingress/
cd kubernetes-ingress/deployments/helm-chart
git checkout v1.9.0</pre></pre>
<pre class="highlight"><pre>helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm repo update
kubectl create namespace ingress
helm install nginx ingress-nginx/ingress-nginx --set rbac.create=true -n ingress --version 3.7.1</pre></pre>
<p>Reference: https://docs.nginx.com/nginx-ingress-controller/installation/installation-with-helm/</p>
<h2>Failed to update lock: configmaps “ingress-controller-leader”</h2>
<pre class="highlight"><pre>Failed to update lock: configmaps "ingress-controller-leader" is forbidden: User "system:serviceaccount:ingress:nginx-ingress-nginx" cannot update resource "configmaps" in API group "" in the namespace "ingress"</pre></pre>
<p>If you run into the above error on the ingress deployment, this is due to the ingress user not having permissions to update the configmap for the custom deployment. This is fixed by the below steps:</p>
<p>Run the following command to get the name of your ingress controller config map:</p>
<pre class="highlight"><pre>kubectl get cm -n ingress | grep "[environment]"</pre></pre>
<p>(Make a note of this)</p>
<p>Now edit the role created by the helm installation:</p>
<pre class="highlight"><pre>kubectl edit role -n ingress nginx-ingress-nginx</pre></pre>
<p>Above the section “ingress-controller-leader-nginx”, add the following:</p>
<pre class="highlight"><pre>- apiGroups:
 - ""
 resourceNames:
  - ingress-controller-leader-[environment]
 resources:
  - configmaps
 verbs:
  - get
  - update</pre></pre>
<p>Restart the deployment to pick up the change and the errors should subside:</p>
<pre class="highlight"><pre>kubectl rollout restart deployment [environment]-ingress-controller -n ingress</pre></pre>
</div>
