<head>
    <title>Tim Harrison</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
        integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.1.0/css/all.css">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro&display=swap" rel="stylesheet">
    <link rel='stylesheet' href='/static/styles.css' />
</head>

<div id="header_block">
    <p class="deploy_message">This site has been deployed from Github repository <a
            href="https://github.com/tjtharrison/README.md" target="_blank">tjtharrison/README.md</a></p>
    <div id="header_wrapper">


        <p><img class="me" src="/img/timh.png" /></p>

        <h2>Tim Harrison</h2>
        <h3>Infrastructure Security Team Lead</h3>

        <ul class="navigation">
            <li><a href="/">Home</a></li>
            <li><a href="/pages/runbooks/">Runbooks</a></li>
            <li><a href="/pages/guides">Guides</a></li>
            <li><a target="_blank"
                    href="https://www.credly.com/badges/f3630def-a568-424b-a8eb-e8857e296e24/public_url">Credly <i
                        class="fa-solid fa-arrow-up-right-from-square"></i></a></li>
            <li><a target="_blank" href="https://github.com/tjtharrison">Github <i
                        class="fa-solid fa-arrow-up-right-from-square"></i></a></li>
            <li><a target="_blank" href="https://www.linkedin.com/in/tim-harrison-47b11159/"> LinkedIn <i
                        class="fa-solid fa-arrow-up-right-from-square"></i></a></li>
        </ul>


    </div>
</div>

<div id="body">
    </div></div><h1>Pushing to a git repository using Gitlab CI</h1>
<p>Recently I have been migrating a Jenkins environment to Gitlab CI for automated builds. One thing that was not immediately clear from the documentation on how to push back to your Git repository during the build pipeline.</p>
<p>This process was used heavily throughout the process to automate the bumping of versions in npm package.json files and committing these back to the git branch once bumped.</p>
<p>The first step to acheive this is to create a Personal access token for your account with read and write access to your projects. On Gitlab.com you can use the link below:</p>
<p><a href="https://gitlab.com/-/profile/personal_access_tokens">https://gitlab.com/-/profile/personal_access_tokens</a></p>
<p>Make a note of your access token once generated as this will not be displayed again!</p>
<p>The next stage is to go to the Settings &gt; CI/CD &gt; Variables for either your project or the containing group if you wish to use this key across multiple projects.</p>
<p>Create a new variable here named CI_ACCESS_TOKEN (Or similar, if you use something different here â€“ Ensure you make a note!) with the value as the access token you generated in the previous step. With this being a password you should ensure to mask the variable so that it is not printed in your CI logs.</p>
<p>The below is a very simple gitlab-ci.yaml file which simply clones your repository, bumps using the npm version command, before pushing the changes back to the master branch on Gitlab.</p>
<p><code>image: node:latest
stages:
  - "Git checkout"
  - "Prepare Build"
  - "Bump Version"
  - "commit"
git-pull:
  stage: "Git checkout"
  script:
    - git checkout $CI_COMMIT_BRANCH
    - git pull
    - git status
npm-bump:
  ## Bump the project version
  stage: "Bump Version"
  script:
    - echo "Bumping project version"
    - npm version --no-git-tag-version patch
commit-files:
  ## Commit new files back to master branch
  stage: commit
  before_script:
    - git config --global user.email "gituser@example.com"
    - git config --global user.name "Gitlab CI"
  script:
    - echo "Committing updated files to git"
    - cat package.json
    - git add package.json
    - git commit -m "Bumped package to $SERVICE_VERSION" 
    ## Push back to Gitlab using secret token created earlier with "skip-ci" option to stop builds triggering in a loop
    - git push "https://${GITLAB_USER_NAME}:${CI_ACCESS_TOKEN}@${CI_REPOSITORY_URL#*@}" "HEAD:${CI_COMMIT_REF_NAME}" -o skip-ci</code></p>
</div>