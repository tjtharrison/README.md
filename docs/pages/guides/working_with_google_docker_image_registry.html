<head>
    <title>Tim Harrison</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
        integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.1.0/css/all.css">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro&display=swap" rel="stylesheet">
    <link rel='stylesheet' href='/static/styles.css' />
    <link rel='stylesheet' href='/static/mobile.css' />
</head>

<div id="header_block">
    <p class="deploy_message">This site has been generated and deployed from Github repository <a
            href="https://github.com/tjtharrison/README.md" target="_blank">tjtharrison/README.md</a></p>
    <div id="header_wrapper">


        <p><img class="me" src="/img/timh.png" /></p>

        <h2>Tim Harrison</h2>
        <h3>DevSecOps Team Lead</h3>

        <ul class="navigation">
            <li><a href="/">Home</a></li>
            <li><a target="_blank" href="https://tjtharrison.medium.com/">medium.com</a></li>
            <li><a href="/pages/guides">Sysadmin Guides</a></li>
            <li><a target="_blank"
                    href="https://www.credly.com/users/tim-harrison.41ce8b8d/badges">Credly <i
                        class="fa-solid fa-arrow-up-right-from-square"></i></a></li>
            <li><a target="_blank" href="https://github.com/tjtharrison">Github <i
                        class="fa-solid fa-arrow-up-right-from-square"></i></a></li>
            <li><a target="_blank" href="https://www.linkedin.com/in/tim-harrison-47b11159/"> LinkedIn <i
                        class="fa-solid fa-arrow-up-right-from-square"></i></a></li>
        </ul>


    </div>
</div>

<div id="body">
    </div></div><h1>Working with Google Docker Image Registry</h1>
<p>A brief overview of my experience working with the GCP Hosted Google Docker Registry.</p>
<h2>Registration:</h2>
<p>To register for the Google Docker Registry, you can sign up with any Google Account and you will be given $300 credit to spend over the next 12 months. Pricing for the Google Docker registry is very reasonable () so it won’t cost the earth even once this credit has expired.</p>
<h2>Creating the Registry:</h2>
<p>The first step will be to to create your docker image registry on GCP. If you don’t have one – Create an account on Google Cloud Platform. I won’t provide details on how to do this here..</p>
<p>https://console.cloud.google.com/</p>
<p>When you have registered and signed into your account, the first thing you should do is create a project (To not store your images in the default project). To do this, click on the dropdown menu at the top (Displaying “My First Project”) and click “New Project”.</p>
<p>On the popup window, type an appropriate name and create your project. Ensure it’s selected at the top of the screen.</p>
<p>Now browse down to “Container Registry” on the left hand side of the screen.</p>
<h2>Signing into your Google Account from your Docker host:</h2>
<p>This guide assumes your docker host runs Ubuntu but you can adjust as appropriate for other Operating Systems.</p>
<p>The first stage is to install the latest Google Cloud SDK (https://cloud.google.com/sdk/docs/)</p>
<pre class="highlight"><pre>echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
sudo apt-get update
sudo apt-get install -y apt-transport-https ca-certificates gnupg
sudo apt-get install -y google-cloud-sdk</pre></pre>
<p>You should now run the below to setup your Google Account. Select the project you created above for your images when prompted.</p>
<pre class="highlight"><pre>gcloud init</pre></pre>
<p>Once the above has completed, you can run the below to Authenticate Docker with the Google Cloud:</p>
<pre class="highlight"><pre>gcloud auth configure-docker</pre></pre>
<h2>Signing into Google Image Registry from Kubernetes:</h2>
<p>This process is required when you are running a baremetal Kubernetes cluster with images hosted in Google Cloud.</p>
<p>Firstly, from your Google Cloud Account – Create a new Service Account. Browse to “APIs and Services” on the left hand side and select “Credentials”.</p>
<p>On the following page, select “Create credentials” tand Service account key.</p>
<p>Give your account an appropriate namd and select Storage &gt;  Source Repository Administrator as the Role – Download as a json.</p>
<p>Now run the below kubectl command to create the secret:</p>
<pre class="highlight"><pre>kubectl create secret docker-registry gcp-registry \
--docker-server=eu.gcr.io \
--docker-username=_json_key \
--docker-password="$(cat [your-downloaded-file.json])" \
--docker-email=your@email.address</pre></pre>
<p>Now, in your deployment yamls, ensure to include the below to use these credentials when pulling images from the GCP registry:</p>
<pre class="highlight"><pre>spec:
 imagePullSecrets:
  - name: gcp-registry</pre></pre>
<p>Finally, patch your default service account to use this secret:</p>
<pre class="highlight"><pre>kubectl patch serviceaccount default -p '{"imagePullSecrets": [{"name": "gcp-registry"}]}'</pre></pre>
</div>
